version: '3.8'

services:
    database:
        image: postgres:14
        restart: always
        environment:
            POSTGRES_DB: mydatabase
            POSTGRES_USER: user
            POSTGRES_PASSWORD: password
        volumes:
            - db_data:/var/lib/postgresql/data
        healthcheck:
            test: [ "CMD-SHELL", "pg_isready -d mydatabase -U user" ]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s

    statistics:
        build:
            dockerfile: Dockerfile
        ports:
            - "8000:8000"
        environment:
            REACT_APP_API_URL: http://localhost:8000/
            POSTGRES_DB: mydatabase
            POSTGRES_USER: user
            POSTGRES_PASSWORD: password
            POSTGRES_HOST: database
            POSTGRES_PORT: 5432
        depends_on:
            database:
                condition: service_healthy
        volumes:
            - ./app/backend/vacations_statistics_backend:/app/backend

        command: >
          sh -c "python manage.py migrate &&
                 python manage.py runserver 0.0.0.0:8000"

    
